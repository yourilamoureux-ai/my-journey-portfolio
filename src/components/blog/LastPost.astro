---
import { getCollection } from "astro:content";
import Tag from "../ui/Tag.astro";
import ReadMore from "../ui/ReadMore.astro";
import Capsule from "../ui/Capsule.astro";
import DatePub from "./DatePub.astro";
import allStaticData from "../../content/staticdata/AllStaticData.json";

const locale = Astro.currentLocale;

// Load fallback from static data
const fallbackImage = allStaticData.fallbackImage;

// Fetch posts for the current language
const allPostsForLocale = await getCollection('blog', ({ id }) => {
  if (locale === 'en') {
    return !['fr/', 'de/', 'es/'].some(lang => id.startsWith(lang));
  }
  return id.startsWith(locale + '/');
});

// Filter drafts and sort to find the latest post
const publishedPosts = allPostsForLocale
  .filter(post => (import.meta.env.PROD ? !post.data.draft : true))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const latestPost = publishedPosts[0];
---

{latestPost &&
  (() => {
    const { title, pubDate, tags = [], languages = [], image } = latestPost.data;

    // Use fallback if image is missing
    const finalImage = image?.url ? image : fallbackImage;

    const imageAlt = finalImage.alt || title;
    const langPrefix = locale === 'en' ? '' : `/${locale}`;
    const postUrl = `${langPrefix}/blog/posts/${latestPost.slug.split('/')[1]}`;

    return (
      <div
        style={{ backgroundImage: `url(${finalImage.url})` }}
        class="h-full hover:shadow-[0_20px_50px_rgba(13,188,130,0.2)] flex flex-col overflow-hidden rounded-2xl bg-linear-to-br bg-center bg-cover transition-all ease-in-out duration-200"
        role="article"
        aria-labelledby="post-title"
      >
        <article class="h-full flex flex-col justify-between max-sm:bg-zinc-900 max-sm:relative sm:bg-linear-to-t from-black/95 from-25% to-transparent max-sm:from-60% p-8 max-md:p-6">
          <a href={postUrl} class="sm:hidden relative top-0 left-0 w-full h-auto -z-0" aria-hidden="true">
            <img src={finalImage.url} alt={imageAlt} class="w-full h-auto" loading="lazy" />
          </a>
          <div class="w-full flex pb-5 gap-2 flex-wrap justify-end z-10 max-sm:px-6 max-sm:pt-6" role="list" aria-label="Programming languages">
            {languages.map((language) => (
              <Capsule lang={language} />
            ))}
          </div>
          <a href={postUrl} class="text-mint-50 gap-3 h-full flex items-end max-sm:px-6 rounded-lg transition-all" aria-label={`Read article: ${title}`}>
            <div class="gap-3 flex flex-col justify-end drop-shadow-[1px_6px_1px_rgba(0,0,0,0.3)]">
              <DatePub date={pubDate} class="text-mint-50" />
              <h2 id="post-title" class="text-4xl max-xl:text-3xl max-sm:text-2xl font-bold">
                <span>{title}</span>
              </h2>
              <ReadMore class="text-mint-50" />
            </div>
          </a>
          <div class="gap-2 mt-3 justify-start items-center flex flex-row flex-wrap max-sm:px-6 max-sm:pb-6" role="list" aria-label="Article tags">
            {tags.map((tag) => (
              <Tag tag={tag} forceDark="true">{tag}</Tag>
            ))}
          </div>
        </article>
      </div>
    );
  })()
}
